{% extends "base.html" %}
{% block title %}TechTV | Video Detail{% endblock %}
{% block pagetitle %}TechTV: Video Detail{% endblock %}
{% block content %}

<form class="edit-video" action="{% url 'api:video-detail' object.id %}" method="PUT">
  <table>
    <tr>
      <th>Uploaded by:</th>
      <td>{{ object.creator }}</td>
    </tr>
    <tr>
      <th>{{ form.title.label_tag }}</th>
      <td>{{ form.title }}</td>
    </tr>
    <tr>
      <th>{{ form.description.label_tag }}</th>
      <td>{{ form.description }}</td>
    </tr>
    <tr>
      <th>{{ form.moira_lists.label_tag }}</th>
      <td>
        {{ form.moira_lists }}
        <span>Type in as many lists as you want, separated by spaces.</span>
      </td>
    </tr>
  </table>
  <input type="submit" value="Update"
    {% if not request.user.is_staff %}disabled{% endif %} />
</form>
<hr>
<p>Links:</p>
<ul data-video-id="{{ object.id }}">
  <li><a href="{{ object.s3_url }}">S3 link</a></li>
  <li><a href="{{ object.cloudfront_url }}">CloudFront direct link</a></li>
  <li><button>Generate CloudFront signed link</button></li>
</ul>
<h4>
<form class="delete-video" action="{% url 'api:video-detail' object.id %}" method="DELETE">
  <input type="submit" value="Delete video"
    {% if not request.user.is_staff %}disabled{% endif %} />
  <label>
    <input type="checkbox" name="s3" />
    Also delete from S3
  </label>
</form>

<script>
  let CSRF = "{{ csrf_token }}";

  let handleButtonClick = function(event) {
    let button = event.target;
    let videoId = button.parentNode.parentNode.dataset.videoId;
    fetch(`/api/videos/${videoId}/signed_url/`, {
      credentials: 'same-origin',
    }).then(function(response) {
      if (!response.ok) {
        let text = "error";
        if (response.status === 403) {
          text = "forbidden";
        }
        button.parentNode.appendChild(document.createTextNode(text));
        return;
      }
      response.json().then(function(obj) {
        let signedUrl = obj.url;
        let link = document.createElement("a");
        link.href = signedUrl;
        link.appendChild(document.createTextNode("CloudFront signed link"));
        button.replaceWith(link);
      });
    })
  }

  let handleEdit = function(event) {
    event.preventDefault();
    let form = event.target;
    let data = {
      title: form.querySelector("[name=title]").value,
      description: form.querySelector("[name=description]").value,
      moira_lists: form.querySelector("[name=moira_lists]").value.split(" "),
    }
    let headers = new Headers();
    headers.append("X-CSRFToken", CSRF);
    headers.append("Content-Type", "application/json");
    fetch(form.action, {
      method: "PUT",
      headers: headers,
      credentials: 'same-origin',
      body: JSON.stringify(data),
    }).then(function(response) {
      if (response.ok) {
        form.appendChild(document.createTextNode("✓"))
      }
    });
  }
  let handleDelete = function(event) {
    event.preventDefault();
    let form = event.target;
    let headers = new Headers();
    headers.append("X-CSRFToken", CSRF);
    headers.append("Content-Type", "application/json");
    let url = form.action;
    if (form.querySelector("[name=s3]").checked) {
      url += "?s3=1";
    }
    fetch(url, {
      method: "DELETE",
      headers: headers,
      credentials: 'same-origin',
    }).then(function(response) {
      if (response.ok) {
        form.appendChild(document.createTextNode("✓"))
      }
    });
  }
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelector("button").addEventListener("click", handleButtonClick);
    document.querySelector("form.edit-video").addEventListener("submit", handleEdit);
    document.querySelector("form.delete-video").addEventListener("submit", handleDelete);
  });
</script>
{% endblock %}
